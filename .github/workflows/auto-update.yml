name: Infrastructure Sync

on:
  push:
    branches: [ "cicd/autoupdate" ]
    paths:
      - 'nginx/**'
      - 'pihole/**'
      - 'nextcloud/**'
      - 'management/**'
      - 'springproject/**'

jobs:
  apply-config:
    runs-on: self-hosted
    
    steps:
      - name: En GÃ¼ncel AyarlarÄ± Ã‡ek
        uses: actions/checkout@v4

      # DÃœZELTÄ°LMÄ°Å KISIM BURASI
      - name: SÄ±rlarÄ± Kasadan Getir
        run: |
          echo "KalÄ±cÄ± .env dosyalarÄ± deÄŸiÅŸken Ã¼zerinden kopyalanÄ±yor..."
          
          # ${{ vars.SECRETS_PATH }} GitHub'dan dinamik olarak gelir.
          # YarÄ±n klasÃ¶r yolunu deÄŸiÅŸtirirsen, kodu deÄŸil GitHub'daki deÄŸiÅŸkeni gÃ¼ncellersin.
          
          cp ${{ vars.SECRETS_PATH }}/nextcloud.env nextcloud/.env || echo "Nextcloud env bulunamadÄ±"
          cp ${{ vars.SECRETS_PATH }}/nginx.env nginx/.env || echo "Nginx env bulunamadÄ±"
          cp ${{ vars.SECRETS_PATH }}/pihole.env pihole/.env || echo "Pihole env bulunamadÄ±"
          cp ${{ vars.SECRETS_PATH }}/spring.env springproject/.env || echo "Spring env bulunamadÄ±"
          
          echo "âœ… .env dosyalarÄ± yerleÅŸtirildi."

      # ... Buradan sonrasÄ± aynÄ± (docker compose adÄ±mlarÄ±) ...
      - name: Management Servislerini GÃ¼ncelle
        run: |
          if [ -d "management" ]; then
            echo "Management konfigÃ¼rasyonu uygulanÄ±yor..."
            docker compose -f management/docker-compose.yml up -d --remove-orphans
          fi

      - name: Nginx AyarlarÄ±nÄ± GÃ¼ncelle
        run: |
          echo "Nginx konfigÃ¼rasyonu uygulanÄ±yor..."
          docker compose -f nginx/docker-compose.yml up -d --remove-orphans

      - name: Pi-hole AyarlarÄ±nÄ± GÃ¼ncelle
        run: |
          echo "Pi-hole konfigÃ¼rasyonu uygulanÄ±yor..."
          docker compose -f pihole/docker-compose.yml up -d --remove-orphans

      - name: Nextcloud AyarlarÄ±nÄ± GÃ¼ncelle
        run: |
          echo "Nextcloud konfigÃ¼rasyonu uygulanÄ±yor..."
          docker compose -f nextcloud/docker-compose.yml up -d --remove-orphans

      - name: Spring Projesi KonfigÃ¼rasyonunu GÃ¼ncelle
        run: |
          echo "Spring konfigÃ¼rasyonu uygulanÄ±yor..."
          docker compose -f springproject/docker-compose.yml up -d --remove-orphans

      - name: ğŸ§¹ Temizlik
        run: docker image prune -f