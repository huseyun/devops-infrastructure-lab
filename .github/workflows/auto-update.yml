name: Infrastructure Sync

on:
  push:
    branches: [ "cicd/autoupdate" ]
    paths:
      - 'nginx/**'
      - 'pihole/**'
      - 'nextcloud/**'
      - 'management/**'
      - 'springproject/**'
      - 'docker-compose.yml'

jobs:
  apply-config:
    runs-on: self-hosted
    
    steps:
      - name: ğŸ“¥ En GÃ¼ncel AyarlarÄ± Ã‡ek
        uses: actions/checkout@v4

      # 1. Management (Watchtower vb.)
      - name: ğŸ› ï¸ Management Servislerini GÃ¼ncelle
        run: |
          if [ -d "management" ]; then
            echo "Management konfigÃ¼rasyonu uygulanÄ±yor..."
            docker compose -f management/docker-compose.yml up -d --remove-orphans
          fi

      # 2. Nginx (Proxy)
      - name: ğŸŒ Nginx AyarlarÄ±nÄ± GÃ¼ncelle
        run: |
          echo "Nginx konfigÃ¼rasyonu uygulanÄ±yor..."
          docker compose -f nginx/docker-compose.yml up -d --remove-orphans

      # 3. Pi-hole (DNS)
      - name: ğŸ›¡ï¸ Pi-hole AyarlarÄ±nÄ± GÃ¼ncelle
        run: |
          echo "Pi-hole konfigÃ¼rasyonu uygulanÄ±yor..."
          docker compose -f pihole/docker-compose.yml up -d --remove-orphans

      # 4. Nextcloud
      - name: â˜ï¸ Nextcloud AyarlarÄ±nÄ± GÃ¼ncelle
        run: |
          echo "Nextcloud konfigÃ¼rasyonu uygulanÄ±yor..."
          docker compose -f nextcloud/docker-compose.yml up -d --remove-orphans

      # 5. Spring Boot Projesi (YENÄ° EKLENEN ADIM)
      - name: â˜• Spring Projesi KonfigÃ¼rasyonunu GÃ¼ncelle
        run: |
          echo "Spring konfigÃ¼rasyonu (Properties/Compose) uygulanÄ±yor..."
          # ImajÄ± Watchtower gÃ¼ncellese bile, yeni port/env ayarlarÄ±nÄ± bu komut uygular.
          docker compose -f springproject/docker-compose.yml up -d --remove-orphans

      - name: ğŸ§¹ Temizlik
        run: docker image prune -f